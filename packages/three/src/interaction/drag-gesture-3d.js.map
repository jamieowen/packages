{
  "version": 3,
  "sources": ["/Users/jamieowen/Workspace/packages/packages/three/src/interaction/drag-gesture-3d.ts"],
  "sourcesContent": ["import { GestureStream3D } from \"./gesture-stream-3d\";\nimport {\n  forceFriction,\n  forceStream,\n  particleStream,\n  invalidatePositionThreshold,\n  invalidate,\n  IMotionEvent,\n} from \"@jamieowen/motion\";\nimport { add3, set3, sub2, sub3, Vec, Vec3, Vec3Like } from \"@thi.ng/vectors\";\nimport { reactive, StreamSync, sync } from \"@thi.ng/rstream\";\nimport { map, comp, sideEffect, filter, step } from \"@thi.ng/transducers\";\n\n// type DragGesture3D = GestureEvent3D & {\n//   translate: Vec;\n//   delta: Vec;\n//   start: Vec;\n// };\n\nexport interface DragGesture3DEvent {\n  gesture: GestureStream3D;\n  particle: IMotionEvent<\"particle\">;\n}\n\nexport interface DragGesture3DOpts {\n  maxSpeed: number;\n  friction: number;\n  initialPosition?: Vec;\n}\n\nexport const dragGesture3d = (\n  gesture$: GestureStream3D,\n  opts: Partial<DragGesture3DOpts> = {}\n) => {\n  const { maxSpeed = 0.8, friction = 0.12, initialPosition = [0, 0, 0] } = opts;\n  // gesture position\n  let translate: Vec;\n  let delta: Vec;\n  let start: Vec;\n  let previous: Vec;\n  // particle position\n  let particleStart: Vec;\n  let isDragging: boolean = false;\n  let time: number = 0;\n\n  const threshold = 0.005;\n  const [force$, setForces] = forceStream([], []);\n  const particle$ = particleStream(force$, reactive({ maxSpeed, threshold }));\n  const frictionF = forceFriction(friction);\n\n  set3(particle$.deref().data.position, initialPosition);\n\n  let lastp = null;\n  return sync({\n    src: {\n      particle: particle$,\n      gesture: gesture$,\n    },\n    xform: comp(\n      filter(({ gesture, particle }) => {\n        const pchanged = particle !== lastp;\n        lastp = particle;\n        return (gesture.type !== \"move\" && gesture.type !== \"zoom\") || pchanged;\n      }),\n      map(({ gesture, particle }) => {\n        switch (gesture.type) {\n          case \"start\":\n            start = gesture.pos as Vec3Like;\n            previous = start;\n            translate = [0, 0, 0]; // difference between start and end\n            delta = [0, 0, 0]; // difference between frame\n            isDragging = true;\n            particleStart = [...particle.data.position];\n            time = Date.now();\n            break;\n          case \"end\":\n            // gesture will remain in stream buffer until removed.\n            // so test event end\n            if (isDragging) {\n              isDragging = false;\n              setForces([frictionF], [() => delta as Vec3Like]);\n            }\n            break;\n          case \"drag\":\n            translate = sub3([], gesture.pos, start);\n            const now = Date.now();\n            // calc delta with time offset since previous pos\n            if (now - time > 25) {\n              delta = sub3([], gesture.pos, previous);\n              previous = gesture.pos;\n              time = now;\n            }\n            set3(particle.data.position, add3([], particleStart, translate));\n            break;\n        }\n        return {\n          gesture,\n          particle,\n        };\n      })\n    ),\n  });\n};\n"],
  "mappings": "AACA;AAAA;AAAA;AAAA;AAAA;AAQA;AACA;AACA;AAmBO,aAAM,gBAAgB,CAC3B,UACA,OAAmC,OAChC;AACH,QAAM,CAAE,WAAW,KAAK,WAAW,MAAM,kBAAkB,CAAC,GAAG,GAAG,MAAO;AAEzE,MAAI;AACJ,MAAI;AACJ,MAAI;AACJ,MAAI;AAEJ,MAAI;AACJ,MAAI,aAAsB;AAC1B,MAAI,OAAe;AAEnB,QAAM,YAAY;AAClB,QAAM,CAAC,QAAQ,aAAa,YAAY,IAAI;AAC5C,QAAM,YAAY,eAAe,QAAQ,SAAS,CAAE,UAAU;AAC9D,QAAM,YAAY,cAAc;AAEhC,OAAK,UAAU,QAAQ,KAAK,UAAU;AAEtC,MAAI,QAAQ;AACZ,SAAO,KAAK;AAAA,IACV,KAAK;AAAA,MACH,UAAU;AAAA,MACV,SAAS;AAAA;AAAA,IAEX,OAAO,KACL,OAAO,CAAC,CAAE,SAAS,cAAe;AAChC,YAAM,WAAW,aAAa;AAC9B,cAAQ;AACR,aAAQ,QAAQ,SAAS,UAAU,QAAQ,SAAS,UAAW;AAAA,QAEjE,IAAI,CAAC,CAAE,SAAS,cAAe;AAC7B,cAAQ,QAAQ;AAAA,aACT;AACH,kBAAQ,QAAQ;AAChB,qBAAW;AACX,sBAAY,CAAC,GAAG,GAAG;AACnB,kBAAQ,CAAC,GAAG,GAAG;AACf,uBAAa;AACb,0BAAgB,CAAC,GAAG,SAAS,KAAK;AAClC,iBAAO,KAAK;AACZ;AAAA,aACG;AAGH,cAAI,YAAY;AACd,yBAAa;AACb,sBAAU,CAAC,YAAY,CAAC,MAAM;AAAA;AAEhC;AAAA,aACG;AACH,sBAAY,KAAK,IAAI,QAAQ,KAAK;AAClC,gBAAM,MAAM,KAAK;AAEjB,cAAI,MAAM,OAAO,IAAI;AACnB,oBAAQ,KAAK,IAAI,QAAQ,KAAK;AAC9B,uBAAW,QAAQ;AACnB,mBAAO;AAAA;AAET,eAAK,SAAS,KAAK,UAAU,KAAK,IAAI,eAAe;AACrD;AAAA;AAEJ,aAAO;AAAA,QACL;AAAA,QACA;AAAA;AAAA;AAAA;AAAA;",
  "names": []
}
