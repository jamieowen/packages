{
  "version": 3,
  "sources": ["/Users/jamieowen/Workspace/packages/examples/src/motion-trails-example.ts"],
  "sourcesContent": ["import { trace, subscription, State, reactive } from \"@thi.ng/rstream\";\nimport {\n  sketch,\n  createMeshFactory,\n  createDomeSimpleLight,\n  createDomeSimpleOpts,\n  createInstancedMesh,\n  instancedMeshIterator,\n  trailConeGeometry,\n  trailBoxGeometry,\n} from \"@jamieowen/three\";\n// import { createGui } from \"@jamieowen/gui\";\nimport { createGui } from \"../../packages/gui/src\";\nimport {\n  mapPosition,\n  EaseTypes,\n  IMotionEvent,\n  motionParticle,\n  particleTrails,\n  particleIterator,\n} from \"@jamieowen/motion\";\n\nimport {\n  BufferAttribute,\n  BufferGeometry,\n  MeshStandardMaterial,\n  Line,\n  LineBasicMaterial,\n  DynamicDrawUsage,\n  Mesh,\n  Object3D,\n  Group,\n  Vector3,\n  Quaternion,\n  ArrowHelper,\n} from \"three\";\nimport { map, sideEffect } from \"@thi.ng/transducers\";\nimport { normalize, set3, sub3, Vec } from \"@thi.ng/vectors\";\nimport { memoize1 } from \"@thi.ng/memoize\";\n\nconst TRAIL_GEOMETRIES: Record<string, (x?: any) => BufferGeometry> = {\n  cone: memoize1<any, BufferGeometry>(() => {\n    return trailConeGeometry();\n  }),\n  box: memoize1<any, BufferGeometry>(() => {\n    return trailBoxGeometry();\n  }),\n};\nconst gui = createGui({\n  trail: Object.keys(TRAIL_GEOMETRIES),\n  scale: [2, 1, 5, 0.01],\n  thin: [0.7, 0.2, 2, 0.01],\n  // motion: [\"sine\"],\n});\n\nconst trailGeometry = reactive<BufferGeometry>(null);\n\ngui.subscribe({\n  next: ({ values: { trail } }) => {\n    const trailGeom = TRAIL_GEOMETRIES[trail]();\n    trailGeometry.next(trailGeom);\n  },\n});\n\n/**\n * Render Functions.\n */\nconst meshFactory = createMeshFactory();\n\nconst renderTracer = (parent: Object3D) => {\n  meshFactory.box();\n  meshFactory.lambertMaterial({\n    color: \"#efefef\",\n    emissive: \"#efefef\",\n    emissiveIntensity: 0.25,\n  });\n  const mesh = meshFactory.mesh(parent);\n  mesh.castShadow = true;\n  mesh.scale.multiplyScalar(0.25);\n  return subscription<\n    IMotionEvent<\"transform\" | \"particle\">,\n    IMotionEvent<\"transform\" | \"particle\">\n  >({\n    next: (ev) => {\n      mesh.position.fromArray(ev.data.position);\n    },\n  });\n};\n\n/**\n * Set direction took from\n * https://github.com/mrdoob/three.js/blob/master/src/helpers/ArrowHelper.js\n *\n * Couldn't seem to get\n * https://github.com/mrdoob/three.js/blob/master/src/math/Quaternion.js\n * setFromUnitVectors working in a similar way.\n */\nconst setDirection = (() => {\n  const _axis = new Vector3();\n  return (dir: Vector3, quaternion: Quaternion) => {\n    // dir is assumed to be normalized\n    if (dir.y > 0.99999) {\n      quaternion.set(0, 0, 0, 1);\n    } else if (dir.y < -0.99999) {\n      quaternion.set(1, 0, 0, 0);\n    } else {\n      _axis.set(dir.z, 0, -dir.x).normalize();\n      const radians = Math.acos(dir.y);\n      quaternion.setFromAxisAngle(_axis, radians);\n    }\n  };\n})();\n\nconst renderTrails = (count: number, parent: Object3D) => {\n  const mesh = new Mesh(\n    trailGeometry.deref(),\n    new MeshStandardMaterial({\n      color: \"yellow\",\n    })\n  );\n  mesh.castShadow = true;\n  parent.add(mesh);\n\n  const vec1 = new Vector3(1, 0, 0);\n  // const vec2 = new Vector3(0, 0, 1);\n  // const quat = new Quaternion();\n  const ah = new ArrowHelper(undefined, undefined, 3);\n  parent.add(ah);\n  const adir = new Vector3();\n  // const mat = new Matrix4();\n  const vel: Vec = [];\n\n  return subscription<\n    IMotionEvent<\"particle-array\">,\n    IMotionEvent<\"particle-array\">\n  >({\n    next: (ev) => {\n      // pick a single point\n      const targ = ev.data[10];\n      const prev = ev.data[4];\n\n      if (targ) {\n        const gval = gui.deref().values;\n        mesh.visible = true;\n        mesh.geometry = trailGeometry.deref();\n        mesh.position.fromArray(targ.position);\n        mesh.scale.set(gval.thin, gval.scale, gval.thin);\n\n        // Velocity to Mesh\n        normalize(null, sub3(vel, targ.position, prev.position));\n        vec1.fromArray(vel);\n        setDirection(vec1, mesh.quaternion);\n        // Arrow Helper.\n        ah.position.fromArray(targ.position);\n        adir.fromArray(vel);\n        ah.setDirection(adir);\n      } else {\n        mesh.visible = false;\n      }\n    },\n  });\n};\n\nconst renderLines = (count: number, parent: Object3D) => {\n  const positions = new BufferAttribute(new Float32Array(3 * count), 3);\n  const geometry = new BufferGeometry();\n  positions.usage = DynamicDrawUsage;\n  geometry.setAttribute(\"position\", positions);\n  const lines = new Line(\n    geometry,\n    new LineBasicMaterial({\n      color: \"white\",\n    })\n  );\n  parent.add(lines);\n\n  return subscription<\n    IMotionEvent<\"particle-array\">,\n    IMotionEvent<\"particle-array\">\n  >({\n    next: (ev) => {\n      const arr = ev.data;\n      for (let i = 0; i < arr.length; i++) {\n        positions.setXYZ(\n          i,\n          arr[i].position[0],\n          arr[i].position[1],\n          arr[i].position[2]\n        );\n      }\n      geometry.drawRange.count = arr.length;\n      positions.needsUpdate = true;\n    },\n    error: (err) => {\n      throw err;\n    },\n  });\n};\n\nsketch(({ render, scene, controls, renderer }) => {\n  const dome = createDomeSimpleLight(\n    scene,\n    createDomeSimpleOpts({\n      color: \"darkblue\",\n      showHelpers: false,\n    })\n  );\n  renderer.shadowMap.enabled = true;\n  dome.floor.position.y = -5;\n  controls.object.position.multiplyScalar(3);\n  // Trail Types.\n\n  // Parent container to apply center offset;\n  const group = new Group();\n  scene.add(group);\n\n  const points$ = Object.entries(EaseTypes)\n    .filter(([key]) => key.indexOf(\"InOut\") === -1)\n    .filter(([key]) => key.indexOf(\"In\") > -1)\n    .slice(0, 1)\n    .map(([_key, easeFn], idx) =>\n      motionParticle()\n        .transform(\n          mapPosition((t, pos) => {\n            // t *= 0.1;\n            pos[0] = 0;\n            // pos[2] = idx * -1.1 + 1.1 * 13 * 0.5;\n            pos[2] = idx * 1.0 + Math.sin(t * 8.0) * 2.0;\n            // pos[1] = 1 + Math.sin(t * 3.0);\n            const len = 3.0;\n            const T = t + idx * 0.2;\n            const tt = 1.0 - Math.abs(((T % len) / len) * 2.0 - 1.0); // + Math.sin(idx + t);\n            // pos[1] = easeFn(tt) * 3.0 + 1.0;\n            pos[1] = Math.sin(t * 3 + idx) * 3 + 4 + easeFn(tt) * 3.0;\n          })\n          // invalidatePosition()\n        )\n        .subscribe(renderTracer(group))\n    );\n\n  const trailLength = 20;\n  points$.map((p$) =>\n    p$\n      .subscribe(particleTrails(trailLength))\n      .subscribe(\n        particleIterator({\n          xform: sideEffect((ev) => {\n            const pos = ev.data.position;\n            const prev = ev.data.previous;\n            normalize(undefined, sub3(ev.data.velocity, pos, prev));\n            set3(prev, pos);\n\n            pos[0] += (Math.sin(ev.clock.time) + 1.0) * 0.5 + 0.6;\n            // pos[0] += 2.0;\n          }),\n        })\n      )\n      .subscribe(renderTrails(trailLength, group))\n      .subscribe(renderLines(trailLength, group))\n  );\n\n  // group.position.set((-trailLength * 0.5) / 2, 0, -points$.length / 2);\n  group.position.x = -trailLength / 2;\n  group.position.y = -5;\n\n  render(() => {});\n});\n"],
  "mappings": "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",
  "names": []
}
