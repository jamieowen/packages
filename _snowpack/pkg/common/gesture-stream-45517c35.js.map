{"version":3,"file":"gesture-stream-45517c35.js","sources":["../../../../../node_modules/@thi.ng/rstream-gestures/gesture-stream.js"],"sourcesContent":["import { isBoolean } from \"@thi.ng/checks\";\nimport { clamp } from \"@thi.ng/math\";\nimport { fromDOMEvent, merge } from \"@thi.ng/rstream\";\nimport { map } from \"@thi.ng/transducers\";\nconst START_EVENTS = new Set([\n    \"mousedown\",\n    \"touchmove\",\n    \"touchstart\",\n    \"mousemove\",\n]);\nconst END_EVENTS = new Set([\"mouseup\", \"touchend\", \"touchcancel\"]);\nconst BASE_EVENTS = [\"mousemove\", \"mousedown\", \"touchstart\", \"wheel\"];\nconst EVENT_GESTURETYPES = {\n    touchstart: \"start\",\n    touchmove: \"drag\",\n    touchend: \"end\",\n    touchcancel: \"end\",\n    mousedown: \"start\",\n    mouseup: \"end\",\n    wheel: \"zoom\",\n};\n/**\n * Attaches mouse & touch event listeners to given DOM element and\n * returns a stream of {@link GestureEvent}s and their\n * {@link GestureInfo} details.\n *\n * In multi-touch environments, a `GestureEvent` can contain multiple\n * such `GestureInfo` objects (one per active touch). In general, the\n * `click` and `delta` values are only present if the abstracted event\n * `type == \"drag\"`. Both (and `pos` too) are 2-element arrays\n * of `[x,y]` coordinates.\n *\n * The `zoom` value is always present, but is only updated with wheel\n * events. The value will be constrained to `minZoom` ... `maxZoom`\n * interval (provided via options object).\n *\n * Note: If using `preventDefault` and attaching the event stream to\n * `document.body`, the following event listener options SHOULD be used:\n *\n * @example\n * ```ts\n * eventOpts: { passive: false }\n * ```\n *\n * {@link https://www.chromestatus.com/features/5093566007214080 }\n *\n * @param el -\n * @param opts -\n */\nexport const gestureStream = (el, _opts) => {\n    const opts = Object.assign({ id: \"gestures\", zoom: 1, absZoom: true, minZoom: 0.25, maxZoom: 4, smooth: 1, eventOpts: { capture: true }, preventDefault: true, preventScrollOnZoom: true, preventContextMenu: true, local: true, scale: false }, _opts);\n    const active = [];\n    let zoom = clamp(opts.zoom, opts.minZoom, opts.maxZoom);\n    let zoomDelta = 0;\n    let numTouches = 0;\n    let tempStreams;\n    const isBody = el === document.body;\n    const tempEvents = [\n        \"touchend\",\n        \"touchcancel\",\n        \"touchmove\",\n        \"mouseup\",\n    ];\n    !isBody && tempEvents.push(\"mousemove\");\n    opts.preventContextMenu &&\n        el.addEventListener(\"contextmenu\", (e) => e.preventDefault());\n    const gestureStart = (etype, events, bounds, isTouch) => {\n        const isStart = etype === \"mousedown\" || etype === \"touchstart\";\n        for (let t of events) {\n            const id = t.identifier || 0;\n            const pos = getPos(t, bounds, opts.local, opts.scale);\n            let touch = active.find((t) => t.id === id);\n            if (!touch && isStart) {\n                touch = { id, start: pos };\n                active.push(touch);\n                numTouches++;\n            }\n            if (touch) {\n                touch.pos = pos;\n                touch.delta = [\n                    pos[0] - touch.start[0],\n                    pos[1] - touch.start[1],\n                ];\n                if (isTouch) {\n                    touch.force = t.force;\n                }\n            }\n        }\n        if (isStart && !tempStreams) {\n            tempStreams = tempEvents.map((id) => eventSource(document.body, id, opts, \"-temp\"));\n            stream.addAll(tempStreams);\n            !isBody && stream.removeID(\"mousemove\");\n        }\n    };\n    const gestureEnd = (events) => {\n        for (let t of events) {\n            const id = t.identifier || 0;\n            const idx = active.findIndex((t) => t.id === id);\n            if (idx !== -1) {\n                active.splice(idx, 1);\n                numTouches--;\n            }\n        }\n        if (numTouches === 0) {\n            stream.removeAll(tempStreams);\n            !isBody && stream.add(eventSource(el, \"mousemove\", opts));\n            tempStreams = undefined;\n        }\n    };\n    const updateZoom = (e) => {\n        const zdelta = opts.smooth *\n            (\"wheelDeltaY\" in e\n                ? -e.wheelDeltaY / 120\n                : e.deltaY / 40);\n        zoom = opts.absZoom\n            ? clamp(zoom + zdelta, opts.minZoom, opts.maxZoom)\n            : zdelta;\n        zoomDelta = zdelta;\n    };\n    const stream = merge({\n        src: BASE_EVENTS.map((id) => eventSource(el, id, opts)),\n        xform: map((e) => {\n            opts.preventDefault && e.preventDefault();\n            const etype = e.type;\n            const type = classifyEventType(etype, !!tempStreams);\n            let isTouch = !!e.touches;\n            let events = isTouch\n                ? Array.from(e.changedTouches)\n                : [e];\n            const bounds = el.getBoundingClientRect();\n            if (START_EVENTS.has(etype)) {\n                gestureStart(etype, events, bounds, isTouch);\n            }\n            else if (END_EVENTS.has(etype)) {\n                gestureEnd(events);\n            }\n            else if (type === \"zoom\") {\n                updateZoom(e);\n            }\n            return {\n                event: e,\n                pos: getPos(events[0], bounds, opts.local, opts.scale),\n                buttons: isTouch ? active.length : e.buttons,\n                type,\n                active,\n                zoom,\n                zoomDelta,\n                isTouch,\n            };\n        }),\n    });\n    return stream;\n};\nconst eventSource = (el, type, opts, suffix = \"\") => {\n    let eventOpts = opts.eventOpts;\n    if (type === \"wheel\" && opts.preventScrollOnZoom) {\n        eventOpts = isBoolean(eventOpts)\n            ? { capture: eventOpts, passive: false }\n            : Object.assign(Object.assign({}, eventOpts), { passive: false });\n    }\n    return fromDOMEvent(el, type, eventOpts, { id: type + suffix });\n};\nconst classifyEventType = (etype, isActive) => etype === \"mousemove\"\n    ? isActive\n        ? \"drag\"\n        : \"move\"\n    : EVENT_GESTURETYPES[etype];\nconst getPos = (e, bounds, isLocal, doScale) => {\n    let x = e.clientX;\n    let y = e.clientY;\n    if (isLocal) {\n        x -= bounds.left;\n        y -= bounds.top;\n    }\n    if (doScale) {\n        const dpr = window.devicePixelRatio || 1;\n        x *= dpr;\n        y *= dpr;\n    }\n    return [x | 0, y | 0];\n};\n"],"names":[],"mappings":";;;;;AAIA,MAAM,YAAY,GAAG,IAAI,GAAG,CAAC;AAC7B,IAAI,WAAW;AACf,IAAI,WAAW;AACf,IAAI,YAAY;AAChB,IAAI,WAAW;AACf,CAAC,CAAC,CAAC;AACH,MAAM,UAAU,GAAG,IAAI,GAAG,CAAC,CAAC,SAAS,EAAE,UAAU,EAAE,aAAa,CAAC,CAAC,CAAC;AACnE,MAAM,WAAW,GAAG,CAAC,WAAW,EAAE,WAAW,EAAE,YAAY,EAAE,OAAO,CAAC,CAAC;AACtE,MAAM,kBAAkB,GAAG;AAC3B,IAAI,UAAU,EAAE,OAAO;AACvB,IAAI,SAAS,EAAE,MAAM;AACrB,IAAI,QAAQ,EAAE,KAAK;AACnB,IAAI,WAAW,EAAE,KAAK;AACtB,IAAI,SAAS,EAAE,OAAO;AACtB,IAAI,OAAO,EAAE,KAAK;AAClB,IAAI,KAAK,EAAE,MAAM;AACjB,CAAC,CAAC;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACY,MAAC,aAAa,GAAG,CAAC,EAAE,EAAE,KAAK,KAAK;AAC5C,IAAI,MAAM,IAAI,GAAG,MAAM,CAAC,MAAM,CAAC,EAAE,EAAE,EAAE,UAAU,EAAE,IAAI,EAAE,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,CAAC,EAAE,MAAM,EAAE,CAAC,EAAE,SAAS,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,EAAE,cAAc,EAAE,IAAI,EAAE,mBAAmB,EAAE,IAAI,EAAE,kBAAkB,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,KAAK,EAAE,KAAK,EAAE,EAAE,KAAK,CAAC,CAAC;AAC5P,IAAI,MAAM,MAAM,GAAG,EAAE,CAAC;AACtB,IAAI,IAAI,IAAI,GAAG,KAAK,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC;AAC5D,IAAI,IAAI,SAAS,GAAG,CAAC,CAAC;AACtB,IAAI,IAAI,UAAU,GAAG,CAAC,CAAC;AACvB,IAAI,IAAI,WAAW,CAAC;AACpB,IAAI,MAAM,MAAM,GAAG,EAAE,KAAK,QAAQ,CAAC,IAAI,CAAC;AACxC,IAAI,MAAM,UAAU,GAAG;AACvB,QAAQ,UAAU;AAClB,QAAQ,aAAa;AACrB,QAAQ,WAAW;AACnB,QAAQ,SAAS;AACjB,KAAK,CAAC;AACN,IAAI,CAAC,MAAM,IAAI,UAAU,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;AAC5C,IAAI,IAAI,CAAC,kBAAkB;AAC3B,QAAQ,EAAE,CAAC,gBAAgB,CAAC,aAAa,EAAE,CAAC,CAAC,KAAK,CAAC,CAAC,cAAc,EAAE,CAAC,CAAC;AACtE,IAAI,MAAM,YAAY,GAAG,CAAC,KAAK,EAAE,MAAM,EAAE,MAAM,EAAE,OAAO,KAAK;AAC7D,QAAQ,MAAM,OAAO,GAAG,KAAK,KAAK,WAAW,IAAI,KAAK,KAAK,YAAY,CAAC;AACxE,QAAQ,KAAK,IAAI,CAAC,IAAI,MAAM,EAAE;AAC9B,YAAY,MAAM,EAAE,GAAG,CAAC,CAAC,UAAU,IAAI,CAAC,CAAC;AACzC,YAAY,MAAM,GAAG,GAAG,MAAM,CAAC,CAAC,EAAE,MAAM,EAAE,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;AAClE,YAAY,IAAI,KAAK,GAAG,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,EAAE,KAAK,EAAE,CAAC,CAAC;AACxD,YAAY,IAAI,CAAC,KAAK,IAAI,OAAO,EAAE;AACnC,gBAAgB,KAAK,GAAG,EAAE,EAAE,EAAE,KAAK,EAAE,GAAG,EAAE,CAAC;AAC3C,gBAAgB,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;AACnC,gBAAgB,UAAU,EAAE,CAAC;AAC7B,aAAa;AACb,YAAY,IAAI,KAAK,EAAE;AACvB,gBAAgB,KAAK,CAAC,GAAG,GAAG,GAAG,CAAC;AAChC,gBAAgB,KAAK,CAAC,KAAK,GAAG;AAC9B,oBAAoB,GAAG,CAAC,CAAC,CAAC,GAAG,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC;AAC3C,oBAAoB,GAAG,CAAC,CAAC,CAAC,GAAG,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC;AAC3C,iBAAiB,CAAC;AAClB,gBAAgB,IAAI,OAAO,EAAE;AAC7B,oBAAoB,KAAK,CAAC,KAAK,GAAG,CAAC,CAAC,KAAK,CAAC;AAC1C,iBAAiB;AACjB,aAAa;AACb,SAAS;AACT,QAAQ,IAAI,OAAO,IAAI,CAAC,WAAW,EAAE;AACrC,YAAY,WAAW,GAAG,UAAU,CAAC,GAAG,CAAC,CAAC,EAAE,KAAK,WAAW,CAAC,QAAQ,CAAC,IAAI,EAAE,EAAE,EAAE,IAAI,EAAE,OAAO,CAAC,CAAC,CAAC;AAChG,YAAY,MAAM,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;AACvC,YAAY,CAAC,MAAM,IAAI,MAAM,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAC;AACpD,SAAS;AACT,KAAK,CAAC;AACN,IAAI,MAAM,UAAU,GAAG,CAAC,MAAM,KAAK;AACnC,QAAQ,KAAK,IAAI,CAAC,IAAI,MAAM,EAAE;AAC9B,YAAY,MAAM,EAAE,GAAG,CAAC,CAAC,UAAU,IAAI,CAAC,CAAC;AACzC,YAAY,MAAM,GAAG,GAAG,MAAM,CAAC,SAAS,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,EAAE,KAAK,EAAE,CAAC,CAAC;AAC7D,YAAY,IAAI,GAAG,KAAK,CAAC,CAAC,EAAE;AAC5B,gBAAgB,MAAM,CAAC,MAAM,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC;AACtC,gBAAgB,UAAU,EAAE,CAAC;AAC7B,aAAa;AACb,SAAS;AACT,QAAQ,IAAI,UAAU,KAAK,CAAC,EAAE;AAC9B,YAAY,MAAM,CAAC,SAAS,CAAC,WAAW,CAAC,CAAC;AAC1C,YAAY,CAAC,MAAM,IAAI,MAAM,CAAC,GAAG,CAAC,WAAW,CAAC,EAAE,EAAE,WAAW,EAAE,IAAI,CAAC,CAAC,CAAC;AACtE,YAAY,WAAW,GAAG,SAAS,CAAC;AACpC,SAAS;AACT,KAAK,CAAC;AACN,IAAI,MAAM,UAAU,GAAG,CAAC,CAAC,KAAK;AAC9B,QAAQ,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM;AAClC,aAAa,aAAa,IAAI,CAAC;AAC/B,kBAAkB,CAAC,CAAC,CAAC,WAAW,GAAG,GAAG;AACtC,kBAAkB,CAAC,CAAC,MAAM,GAAG,EAAE,CAAC,CAAC;AACjC,QAAQ,IAAI,GAAG,IAAI,CAAC,OAAO;AAC3B,cAAc,KAAK,CAAC,IAAI,GAAG,MAAM,EAAE,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,OAAO,CAAC;AAC9D,cAAc,MAAM,CAAC;AACrB,QAAQ,SAAS,GAAG,MAAM,CAAC;AAC3B,KAAK,CAAC;AACN,IAAI,MAAM,MAAM,GAAG,KAAK,CAAC;AACzB,QAAQ,GAAG,EAAE,WAAW,CAAC,GAAG,CAAC,CAAC,EAAE,KAAK,WAAW,CAAC,EAAE,EAAE,EAAE,EAAE,IAAI,CAAC,CAAC;AAC/D,QAAQ,KAAK,EAAE,GAAG,CAAC,CAAC,CAAC,KAAK;AAC1B,YAAY,IAAI,CAAC,cAAc,IAAI,CAAC,CAAC,cAAc,EAAE,CAAC;AACtD,YAAY,MAAM,KAAK,GAAG,CAAC,CAAC,IAAI,CAAC;AACjC,YAAY,MAAM,IAAI,GAAG,iBAAiB,CAAC,KAAK,EAAE,CAAC,CAAC,WAAW,CAAC,CAAC;AACjE,YAAY,IAAI,OAAO,GAAG,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC;AACtC,YAAY,IAAI,MAAM,GAAG,OAAO;AAChC,kBAAkB,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,cAAc,CAAC;AAC9C,kBAAkB,CAAC,CAAC,CAAC,CAAC;AACtB,YAAY,MAAM,MAAM,GAAG,EAAE,CAAC,qBAAqB,EAAE,CAAC;AACtD,YAAY,IAAI,YAAY,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE;AACzC,gBAAgB,YAAY,CAAC,KAAK,EAAE,MAAM,EAAE,MAAM,EAAE,OAAO,CAAC,CAAC;AAC7D,aAAa;AACb,iBAAiB,IAAI,UAAU,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE;AAC5C,gBAAgB,UAAU,CAAC,MAAM,CAAC,CAAC;AACnC,aAAa;AACb,iBAAiB,IAAI,IAAI,KAAK,MAAM,EAAE;AACtC,gBAAgB,UAAU,CAAC,CAAC,CAAC,CAAC;AAC9B,aAAa;AACb,YAAY,OAAO;AACnB,gBAAgB,KAAK,EAAE,CAAC;AACxB,gBAAgB,GAAG,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,MAAM,EAAE,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,KAAK,CAAC;AACtE,gBAAgB,OAAO,EAAE,OAAO,GAAG,MAAM,CAAC,MAAM,GAAG,CAAC,CAAC,OAAO;AAC5D,gBAAgB,IAAI;AACpB,gBAAgB,MAAM;AACtB,gBAAgB,IAAI;AACpB,gBAAgB,SAAS;AACzB,gBAAgB,OAAO;AACvB,aAAa,CAAC;AACd,SAAS,CAAC;AACV,KAAK,CAAC,CAAC;AACP,IAAI,OAAO,MAAM,CAAC;AAClB,EAAE;AACF,MAAM,WAAW,GAAG,CAAC,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,GAAG,EAAE,KAAK;AACrD,IAAI,IAAI,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC;AACnC,IAAI,IAAI,IAAI,KAAK,OAAO,IAAI,IAAI,CAAC,mBAAmB,EAAE;AACtD,QAAQ,SAAS,GAAG,SAAS,CAAC,SAAS,CAAC;AACxC,cAAc,EAAE,OAAO,EAAE,SAAS,EAAE,OAAO,EAAE,KAAK,EAAE;AACpD,cAAc,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,EAAE,EAAE,SAAS,CAAC,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC,CAAC;AAC9E,KAAK;AACL,IAAI,OAAO,YAAY,CAAC,EAAE,EAAE,IAAI,EAAE,SAAS,EAAE,EAAE,EAAE,EAAE,IAAI,GAAG,MAAM,EAAE,CAAC,CAAC;AACpE,CAAC,CAAC;AACF,MAAM,iBAAiB,GAAG,CAAC,KAAK,EAAE,QAAQ,KAAK,KAAK,KAAK,WAAW;AACpE,MAAM,QAAQ;AACd,UAAU,MAAM;AAChB,UAAU,MAAM;AAChB,MAAM,kBAAkB,CAAC,KAAK,CAAC,CAAC;AAChC,MAAM,MAAM,GAAG,CAAC,CAAC,EAAE,MAAM,EAAE,OAAO,EAAE,OAAO,KAAK;AAChD,IAAI,IAAI,CAAC,GAAG,CAAC,CAAC,OAAO,CAAC;AACtB,IAAI,IAAI,CAAC,GAAG,CAAC,CAAC,OAAO,CAAC;AACtB,IAAI,IAAI,OAAO,EAAE;AACjB,QAAQ,CAAC,IAAI,MAAM,CAAC,IAAI,CAAC;AACzB,QAAQ,CAAC,IAAI,MAAM,CAAC,GAAG,CAAC;AACxB,KAAK;AACL,IAAI,IAAI,OAAO,EAAE;AACjB,QAAQ,MAAM,GAAG,GAAG,MAAM,CAAC,gBAAgB,IAAI,CAAC,CAAC;AACjD,QAAQ,CAAC,IAAI,GAAG,CAAC;AACjB,QAAQ,CAAC,IAAI,GAAG,CAAC;AACjB,KAAK;AACL,IAAI,OAAO,CAAC,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC;AAC1B,CAAC;;;;"}