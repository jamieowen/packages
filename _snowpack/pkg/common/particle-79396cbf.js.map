{"version":3,"file":"particle-79396cbf.js","sources":["../../../../../packages/motion/dist/clock.js","../../../../../packages/motion/dist/base-streams.js","../../../../../packages/motion/dist/particle.js"],"sourcesContent":["import { fromRAF } from \"@thi.ng/rstream\";\nimport { map } from \"@thi.ng/transducers\";\nconst perf = () => {\n    return (typeof performance === \"undefined\" ? Date : performance).now();\n};\nexport const clock = (opts) => {\n    let then = perf();\n    let start = then;\n    const raf = fromRAF(opts).transform(map((frame) => {\n        const now = perf();\n        const delta = (now - then) / 1000;\n        const time = (now - start) / 1000;\n        then = now;\n        return { frame, delta, time };\n    }));\n    raf.next(0); // emit an initial 0, otherwise it waits a frame.\n    return raf;\n};\nexport const DEFAULT_CLOCK = (() => {\n    let instance = undefined;\n    return () => {\n        if (!instance) {\n            instance = clock();\n        }\n        return instance;\n    };\n})();\n","import { map } from \"@thi.ng/transducers\";\nimport { DEFAULT_CLOCK } from \"./clock\";\nexport const createTransform = () => {\n    return {\n        position: [0, 0, 0],\n    };\n};\nexport const createParticle = () => {\n    return {\n        velocity: [0, 0, 0],\n        position: [0, 0, 0],\n        acceleration: [0, 0, 0],\n        previous: [0, 0, 0],\n    };\n};\nexport const motionTransform = (tick = DEFAULT_CLOCK()) => {\n    const data = createTransform();\n    const type = \"transform\";\n    return tick.transform(map((clock) => ({ clock, data, type })));\n};\nexport const motionParticle = (tick = DEFAULT_CLOCK()) => {\n    const data = createParticle();\n    const type = \"particle\";\n    return tick.transform(map((clock) => ({ clock, data, type })));\n};\n","import { reactive } from \"@thi.ng/rstream\";\nimport { add3, clampN3, mulN3, set3, dist3, } from \"@thi.ng/vectors\";\n// import { motionStream } from \"./motion-stream\";\n// import { IParticle, ITransform, RafStream } from \"./types\";\nimport { motionParticle } from \"./base-streams\";\nimport { filter } from \"@thi.ng/transducers\";\n// Move to factory functions\nexport class Transform {\n    constructor() {\n        this.position = [0, 0, 0];\n        this.scale = [1, 1, 1];\n        this.rotation = [0, 0, 0];\n    }\n}\n// Move to factory functions\nexport class Particle extends Transform {\n    constructor() {\n        super(...arguments);\n        this.acceleration = [0, 0, 0];\n        this.velocity = [0, 0, 0];\n        this.previous = [0, 0, 0];\n    }\n}\nexport const updateParticle = (particle, forces) => {\n    const { acceleration, velocity, position } = particle;\n    set3(particle.previous, position);\n    forces.forEach((f) => add3(null, acceleration, f(particle)));\n    add3(null, velocity, acceleration);\n    mulN3(null, acceleration, 0);\n    add3(null, position, velocity);\n    // mulN3(null, velocity, 0.75);\n};\nexport const limitVelocityN = (particle, speed) => {\n    clampN3(null, particle.velocity, -speed, speed);\n};\nexport const forceGravity = (grav = 1) => () => {\n    return (_p) => {\n        return [0, grav, 0];\n    };\n};\nexport const forceFriction = (friction = 0.2) => {\n    const res = [0, 0, 0];\n    return (p) => {\n        set3(res, p.velocity);\n        mulN3(null, res, -1);\n        // normalize?\n        mulN3(null, res, friction);\n        return res;\n    };\n};\nexport const forceStream = (\n// continous forces\nforces, \n// 'one hit' pulses\npulses) => {\n    const stream = reactive({ forces, pulses });\n    const setForces = (forces, pulses = []) => {\n        stream.next({ forces, pulses });\n    };\n    return [stream, setForces];\n};\n/**\n * A singular particle Stream class for use in simple\n * particle style effects.  Think gestures ( throw, drag, etc ) and\n * simple primary motion elements like mouse follow effects.\n *\n * IS Very WIP.\n */\nexport const particleStream = (force$, config\n// raf?: RafStream\n) => {\n    config =\n        config == undefined\n            ? reactive({\n                maxSpeed: 10,\n                threshold: 0.05,\n            })\n            : config;\n    let { forces, pulses } = force$.deref();\n    force$.subscribe({\n        next: (f) => {\n            forces = f.forces;\n            pulses = f.pulses;\n        },\n    });\n    let first = true;\n    return motionParticle()\n        .subscribe({\n        next: (ev) => {\n            updateParticle(ev.data, [...forces, ...pulses]);\n            limitVelocityN(ev.data, config.deref().maxSpeed);\n            pulses.splice(0);\n        },\n        error: (err) => {\n            throw err;\n        },\n    })\n        .transform(filter((ev) => {\n        const dis = Math.abs(dist3(ev.data.position, ev.data.previous));\n        const changed = dis > config.deref().threshold || first;\n        first = false;\n        return changed;\n    }));\n};\n"],"names":[],"mappings":"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"}